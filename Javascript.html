<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    // Use google.script.run for communicating with Apps Script backend
    let currentRecords = [];
    // DOM element references using jQuery
    let $eventTableBody, $loadingIndicator, $messageBox, $noRecordsMessage;

    function initializeDOMElements() {
        $eventTableBody = $('#eventTable tbody');
        $loadingIndicator = $('#loadingIndicator');
        $messageBox = $('#messageBox');
        $noRecordsMessage = $('#noRecords');
        const requiredElements = [$eventTableBody, $loadingIndicator, $messageBox, $noRecordsMessage];
        const missingElements = requiredElements.filter($el => $el.length === 0);
        if (missingElements.length > 0) {
            console.error('Some DOM elements could not be found:', missingElements);
            return false;
        }
        return true;
    }

    function showLoading(message = 'Loading data...') {
        $loadingIndicator.text(message).show();
        $messageBox.hide();
    }
    function hideLoading() {
        $loadingIndicator.hide();
    }
    function showMessage(message, type) {
        $messageBox.text(message).removeClass('success error').addClass(type).show();
        hideLoading();
        setTimeout(() => { $messageBox.fadeOut(); }, 5000);
    }
    function formatDateForDisplay(date) {
        if (!date) return '';
        try {
            const dateObj = new Date(date);
            if (isNaN(dateObj.getTime())) return '';
            return dateObj.toLocaleDateString();
        } catch (e) { return ''; }
    }
    function formatDateForInput(date) {
        if (!date) return '';
        try {
            const dateObj = new Date(date);
            if (isNaN(dateObj.getTime())) return '';
            return dateObj.toISOString().split('T')[0];
        } catch (e) { return ''; }
    }
    function renderTable(records) {
        $eventTableBody.empty();
        const filterDateStr = $('#filterDate').val();
        const filterDate = filterDateStr ? new Date(filterDateStr) : null;
        const eventTypeFilter = $('#eventType').val();
        // Get min and max level from dropdowns
        const minLevel = parseInt($('#minLevel').val(), 10) || 1;
        const maxLevel = parseInt($('#maxLevel').val(), 10) || 15;
        //console.log('Filter levels:', { minLevel, maxLevel });
        let filteredRecords = records.filter(record => {
            const level = parseInt(record.level, 10);
            //console.log('Record level:', { person: record.person, event: record.event, level, isNaN: isNaN(level) });
            if (isNaN(level)) return false;
            const isInRange = level >= minLevel && level <= maxLevel;
            //console.log('Level in range:', { level, minLevel, maxLevel, isInRange });
            return isInRange;
        });
        //console.log('Filtered records count:', filteredRecords.length);
        
        // Apply event type filter if set
        if (eventTypeFilter) {
            filteredRecords = filteredRecords.filter(record => {
                return (record.event || '').trim() === eventTypeFilter;
            });
        }
        
        // Apply date filter if set
        if (filterDate) {
            filteredRecords = filteredRecords.filter(record => {
                const begin = new Date(record.begin);
                const end = record.end ? new Date(record.end) : null;
                if (isNaN(begin.getTime())) return false;
                // Normalize filterDate, begin, and end to YYYY-MM-DD for comparison
                const filterYMD = formatDateForInput(filterDate);
                const beginYMD = formatDateForInput(begin);
                const endYMD = end && !isNaN(end.getTime()) ? formatDateForInput(end) : null;
                if (filterYMD === beginYMD) return true;
                if (endYMD && filterYMD === endYMD) return true;
                if (end && !isNaN(end.getTime())) {
                    return filterDate > begin && filterDate < end;
                } else {
                    return filterDate > begin;
                }
            });
        }
        // Sort filteredRecords based on sortBy dropdown
        const sortBy = $('#sortBy').val() || 'person';
        filteredRecords.sort((a, b) => {
            if (sortBy === 'person') {
                return (a.person || '').localeCompare(b.person || '');
            } else if (sortBy === 'begin') {
                const aDate = new Date(a.begin);
                const bDate = new Date(b.begin);
                return aDate - bDate;
            }
            return 0;
        });
        // Table header
        const $theadRow = $('#eventTable thead tr');
        $theadRow.empty();
        $theadRow.append('<th>Person</th><th>Event</th><th>Begin Date</th><th>End Date</th><th>Notes</th>' + (filterDate ? '<th>Since</th>' : ''));
        if (filteredRecords.length === 0) {
            $noRecordsMessage.show();
            return;
        }
        $noRecordsMessage.hide();
        filteredRecords.forEach(record => {
            const $row = $('<tr>');
            if ((record.event || '').trim() === 'Alive') $row.addClass('alive-row');
            let notesText = record.notes || '';
            if ((record.event || '').trim() === 'Alive') {
                const begin = new Date(record.begin);
                const end = record.end ? new Date(record.end) : null;
                if (!isNaN(begin.getTime()) && end && !isNaN(end.getTime())) {
                    let years = end.getFullYear() - begin.getFullYear();
                    let months = end.getMonth() - begin.getMonth();
                    let days = end.getDate() - begin.getDate();
                    if (days < 0) months--;
                    if (months < 0) { years--; months += 12; }
                    if (years < 0) { years = 0; months = 0; }
                    notesText = `${years} years and ${months} months old`;
                }
            }
            // Create clickable date cells
            const $beginDateCell = $('<td>').addClass('clickable-date').text(formatDateForDisplay(record.begin));
            if (record.begin) {
                $beginDateCell.on('click', function(e) {
                    e.stopPropagation();
                    $('#filterDate').val(formatDateForInput(record.begin));
                    saveFiltersToLocalStorage();
                    renderTable(currentRecords);
                });
            }
            const $endDateCell = $('<td>').addClass('clickable-date').text(formatDateForDisplay(record.end));
            if (record.end) {
                $endDateCell.on('click', function(e) {
                    e.stopPropagation();
                    $('#filterDate').val(formatDateForInput(record.end));
                    saveFiltersToLocalStorage();
                    renderTable(currentRecords);
                });
            }
            $row.append(
                $('<td>').text(record.person || ''),
                $('<td>').text(record.event || ''),
                $beginDateCell,
                $endDateCell,
                $('<td>').text(notesText)
            );
            if (filterDate) {
                const begin = new Date(record.begin);
                let sinceText = '';
                if (!isNaN(begin.getTime())) {
                    const diff = diffYearsMonths(begin, filterDate);
                    if (diff) sinceText = diff;
                }
                $row.append($('<td>').text(sinceText));
            }
            $eventTableBody.append($row);
        });
        // ... CSS for .age-row and .clickable-date if needed ...
        hideLoading();
    }
    function diffYearsMonths(start, end) {
        if (!(start instanceof Date) || !(end instanceof Date)) return '';
        if (isNaN(start.getTime()) || isNaN(end.getTime())) return '';
        let years = end.getFullYear() - start.getFullYear();
        let months = end.getMonth() - start.getMonth();
        let days = end.getDate() - start.getDate();
        if (days < 0) months--;
        if (months < 0) { years--; months += 12; }
        if (years < 0) return '';
        let result = '';
        if (years > 0) result += years + 'y';
        if (months > 0) result += (result ? ' ' : '') + months + 'm';
        if (!result) result = '0m';
        return result;
    }
    function saveFiltersToLocalStorage() {
        localStorage.setItem('timelineFilters', JSON.stringify({
            minLevel: $('#minLevel').val(),
            maxLevel: $('#maxLevel').val(),
            filterDate: $('#filterDate').val(),
            eventType: $('#eventType').val(),
            sortBy: $('#sortBy').val()
        }));
    }
    function restoreFiltersFromLocalStorage() {
        const filters = JSON.parse(localStorage.getItem('timelineFilters') || '{}');
        if (filters.minLevel) $('#minLevel').val(filters.minLevel);
        if (filters.maxLevel) $('#maxLevel').val(filters.maxLevel);
        if (filters.filterDate) $('#filterDate').val(filters.filterDate);
        if (filters.eventType) $('#eventType').val(filters.eventType);
        if (filters.sortBy) $('#sortBy').val(filters.sortBy);
    }
    function populateLevelDropdowns() {
        const $minLevel = $('#minLevel');
        const $maxLevel = $('#maxLevel');
        $minLevel.empty();
        $maxLevel.empty();
        
        // Get level labels from localStorage or fetch from server
        const levelLabels = JSON.parse(localStorage.getItem('levelLabels') || '[]');

        // Determine the maximum level dynamically, ensuring at least 15 levels are shown as a fallback.
        const maxLevelFromData = levelLabels.length > 0 
            ? Math.max(...levelLabels.map(l => parseInt(l.level, 10)).filter(Number.isFinite)) 
            : 0;
        const maxLevelToShow = Math.max(15, maxLevelFromData);
        
        for (let i = 1; i <= maxLevelToShow; i++) {
            const label = levelLabels.find(l => l.level == i);
            const displayText = label ? `${i} - ${label.label}` : i.toString();
            $minLevel.append($('<option>').val(i).text(displayText));
            $maxLevel.append($('<option>').val(i).text(displayText));
        }
    }

    function fetchLevelLabels() {
        // This function will now orchestrate the initial data load
        // because restoring filters depends on the dropdowns being populated first.
        const onComplete = () => {
            populateLevelDropdowns();
            restoreFiltersFromLocalStorage();
            if (!$('#sortBy').val()) $('#sortBy').val('begin');
            fetchRecords();
        };

        google.script.run
            .withSuccessHandler(labels => {
                localStorage.setItem('levelLabels', JSON.stringify(labels));
                onComplete();
            })
            .withFailureHandler(error => {
                console.warn('Failed to fetch level labels:', error);
                // Even on failure, proceed to populate dropdowns, restore filters, and fetch data.
                onComplete();
            })
            .getLevelLabels();
    }
    function populateEventTypeDropdown(records) {
        const $eventType = $('#eventType');
        const selectedValue = $eventType.val(); // Store the currently selected value

        const eventTypes = new Set();
        records.forEach(record => {
            if (record.event && record.event.trim()) {
                eventTypes.add(record.event.trim());
            }
        });

        // Clear existing options except "All Events"
        $eventType.find('option:not(:first)').remove();

        // Add event types sorted alphabetically
        Array.from(eventTypes).sort().forEach(eventType => {
            $eventType.append($('<option>').val(eventType).text(eventType));
        });

        // Restore the previously selected value
        $eventType.val(selectedValue);
    }
    $(document).on('change', '#minLevel, #maxLevel, #filterDate, #eventType, #sortBy', function() {
        saveFiltersToLocalStorage();
        renderTable(currentRecords);
    });
    $(document).on('click', '#clearFilters', function() {
        const $minLevel = $('#minLevel');
        const $maxLevel = $('#maxLevel');
        const $filterDate = $('#filterDate');
        const $eventType = $('#eventType');
        const $sortBy = $('#sortBy');
        $minLevel.val('1');
        $maxLevel.val('15');
        $filterDate.val('');
        $eventType.val('');
        $sortBy.val('begin');
        saveFiltersToLocalStorage();
        renderTable(currentRecords);
    });
    function fetchRecords() {
        showLoading();
        google.script.run
            .withSuccessHandler(records => {
                currentRecords = records; // Store the full dataset for filtering
                populateEventTypeDropdown(records); // Populate event type dropdown
                renderTable(currentRecords);
                hideLoading();
            })
            .withFailureHandler(error => {
                showMessage('Error fetching data: ' + error.message, 'error');
            })
            .getData();
    }
    $(document).ready(function() {
        if (initializeDOMElements()) {
            // This function now handles the entire startup sequence to avoid race conditions
            fetchLevelLabels();
        } else {
            console.error('Failed to initialize DOM elements');
            showMessage('Failed to initialize the application. Please refresh the page.', 'error');
        }
    });
</script>
