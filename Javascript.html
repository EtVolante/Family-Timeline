<script>
    // Use google.script.run for communicating with Apps Script backend
    let currentRecords = [];
    let selectedRowId = null; // To keep track of the row being edited/deleted

    // Get DOM elements
    const formTitle = document.getElementById('formTitle');
    const eventForm = document.getElementById('eventForm');
    const personInput = document.getElementById('person');
    const eventInput = document.getElementById('event');
    const beginDateInput = document.getElementById('beginDate');
    const endDateInput = document.getElementById('endDate');
    const notesInput = document.getElementById('notes');
    const levelInput = document.getElementById('level');
    const saveButton = document.getElementById('saveButton');
    const cancelButton = document.getElementById('cancelButton');
    const deleteButton = document.getElementById('deleteButton');
    const eventTableBody = document.querySelector('#eventTable tbody');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const messageBox = document.getElementById('messageBox');
    const noRecordsMessage = document.getElementById('noRecords');

    /**
     * Displays a loading indicator.
     */
    function showLoading(message = 'Loading data...') {
        loadingIndicator.textContent = message;
        loadingIndicator.style.display = 'block';
        messageBox.style.display = 'none'; // Hide any previous messages
    }

    /**
     * Hides the loading indicator.
     */
    function hideLoading() {
        loadingIndicator.style.display = 'none';
    }

    /**
     * Displays a message (success or error).
     * @param {string} message - The message to display.
     * @param {string} type - 'success' or 'error'.
     */
    function showMessage(message, type) {
        messageBox.textContent = message;
        messageBox.className = 'message-box ' + type;
        messageBox.style.display = 'block';
        hideLoading();
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }

    /**
     * Formats a date for display (handles both Date objects and date strings).
     * @param {Date|string} date - The date to format.
     * @returns {string} Formatted date string or empty string if invalid.
     */
    function formatDateForDisplay(date) {
        if (!date) return '';
        try {
            const dateObj = new Date(date);
            if (isNaN(dateObj.getTime())) return '';
            return dateObj.toLocaleDateString();
        } catch (e) {
            return '';
        }
    }

    /**
     * Formats a date for input fields (YYYY-MM-DD format).
     * @param {Date|string} date - The date to format.
     * @returns {string} Formatted date string or empty string if invalid.
     */
    function formatDateForInput(date) {
        if (!date) return '';
        try {
            const dateObj = new Date(date);
            if (isNaN(dateObj.getTime())) return '';
            return dateObj.toISOString().split('T')[0];
        } catch (e) {
            return '';
        }
    }

    /**
     * Renders the data table with records.
     * @param {Array<Object>} records - An array of record objects.
     */
    function renderTable(records) {
        eventTableBody.innerHTML = ''; // Clear existing rows
        currentRecords = records; // Store records globally for easy access

        if (records.length === 0) {
            noRecordsMessage.style.display = 'block';
            return;
        }
        noRecordsMessage.style.display = 'none';

        records.forEach(record => {
            const row = eventTableBody.insertRow();
            row.dataset.id = record.person + '_' + record.event + '_' + record.begin; // Create unique ID

            // Create cells for each field. Order matters for display.
            row.insertCell().textContent = record.person || '';
            row.insertCell().textContent = record.event || '';
            row.insertCell().textContent = formatDateForDisplay(record.begin) || '';
            row.insertCell().textContent = formatDateForDisplay(record.end) || '';
            row.insertCell().textContent = record.notes || '';
            row.insertCell().textContent = record.level || '';

            // Add click listener to select row for editing/deleting
            row.addEventListener('click', () => {
                selectRow(record.person + '_' + record.event + '_' + record.begin);
            });
        });
        hideLoading();
    }

    /**
     * Selects a row in the table, populating the form for editing.
     * @param {string} rowId - The unique ID of the record to select.
     */
    function selectRow(rowId) {
        // Remove selection from previously selected row
        const currentlySelectedRow = document.querySelector('.data-table tr.selected-row');
        if (currentlySelectedRow) {
            currentlySelectedRow.classList.remove('selected-row');
        }

        const rowToSelect = document.querySelector(`.data-table tr[data-id="${rowId}"]`);
        if (rowToSelect) {
            rowToSelect.classList.add('selected-row');
        }

        selectedRowId = rowId;
        const record = currentRecords.find(r => (r.person + '_' + r.event + '_' + r.begin) === rowId);

        if (record) {
            formTitle.textContent = 'Edit Timeline Event';
            personInput.value = record.person || '';
            eventInput.value = record.event || '';
            beginDateInput.value = formatDateForInput(record.begin) || '';
            endDateInput.value = formatDateForInput(record.end) || '';
            notesInput.value = record.notes || '';
            levelInput.value = record.level || '';

            saveButton.textContent = 'Update Event';
            deleteButton.style.display = 'inline-block'; // Show delete button
        }
    }

    /**
     * Clears the form and resets it for adding a new event.
     */
    function resetForm() {
        eventForm.reset();
        formTitle.textContent = 'Add New Timeline Event';
        saveButton.textContent = 'Add Event';
        deleteButton.style.display = 'none'; // Hide delete button
        selectedRowId = null;

        // Remove selection from table
        const currentlySelectedRow = document.querySelector('.data-table tr.selected-row');
        if (currentlySelectedRow) {
            currentlySelectedRow.classList.remove('selected-row');
        }
    }

    /**
     * Fetches all records from the Google Sheet.
     */
    function fetchRecords() {
        showLoading();
        google.script.run
            .withSuccessHandler(records => {
                renderTable(records);
                hideLoading();
            })
            .withFailureHandler(error => {
                showMessage('Error fetching data: ' + error.message, 'error');
            })
            .getData();
    }

    /**
     * Validates the form data before submission.
     * @param {Object} record - The record object to validate.
     * @returns {boolean} True if valid, false otherwise.
     */
    function validateRecord(record) {
        if (!record.person || !record.event || !record.begin) {
            showMessage('Please fill in all required fields (Person, Event, Begin Date).', 'error');
            return false;
        }

        // Validate begin date
        const beginDate = new Date(record.begin);
        if (isNaN(beginDate.getTime())) {
            showMessage('Please enter a valid Begin Date.', 'error');
            return false;
        }

        // Validate end date if provided
        if (record.end) {
            const endDate = new Date(record.end);
            if (isNaN(endDate.getTime())) {
                showMessage('Please enter a valid End Date.', 'error');
                return false;
            }
            if (endDate < beginDate) {
                showMessage('End Date cannot be earlier than Begin Date.', 'error');
                return false;
            }
        }

        // Validate level if provided
        if (record.level) {
            const level = parseInt(record.level);
            if (isNaN(level) || level < 0) {
                showMessage('Level must be a positive number.', 'error');
                return false;
            }
        }

        return true;
    }

    /**
     * Handles form submission for adding or updating records.
     */
    eventForm.addEventListener('submit', function(e) {
        e.preventDefault();
        showLoading('Saving data...');

        const record = {
            person: personInput.value.trim(),
            event: eventInput.value.trim(),
            begin: beginDateInput.value.trim(),
            end: endDateInput.value.trim(),
            notes: notesInput.value.trim(),
            level: levelInput.value.trim()
        };

        if (!validateRecord(record)) {
            return;
        }

        if (selectedRowId) { // Update existing record
            google.script.run
                .withSuccessHandler(() => {
                    showMessage('Record updated successfully!', 'success');
                    resetForm();
                    fetchRecords(); // Refresh table
                })
                .withFailureHandler(error => {
                    showMessage('Error updating record: ' + error.message, 'error');
                })
                .updateRow(record);
        } else { // Add new record
            google.script.run
                .withSuccessHandler(() => {
                    showMessage('Record added successfully!', 'success');
                    resetForm();
                    fetchRecords(); // Refresh table
                })
                .withFailureHandler(error => {
                    showMessage('Error adding record: ' + error.message, 'error');
                })
                .addRow(record);
        }
    });

    /**
     * Handles deletion of a record.
     */
    deleteButton.addEventListener('click', () => {
        if (selectedRowId && confirm('Are you sure you want to delete this timeline event?')) {
            showLoading('Deleting record...');
            google.script.run
                .withSuccessHandler(() => {
                    showMessage('Record deleted successfully!', 'success');
                    resetForm();
                    fetchRecords(); // Refresh table
                })
                .withFailureHandler(error => {
                    showMessage('Error deleting record: ' + error.message, 'error');
                })
                .deleteRow(selectedRowId);
        }
    });

    /**
     * Handles canceling an edit/add operation.
     */
    cancelButton.addEventListener('click', () => {
        resetForm();
    });

    // Initial data load when the page loads
    document.addEventListener('DOMContentLoaded', fetchRecords);

</script>
