<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    // Use google.script.run for communicating with Apps Script backend
    let currentRecords = [];
    let selectedRowId = null; // To keep track of the row being edited/deleted

    // DOM element references using jQuery
    let $formTitle, $eventForm, $personInput, $eventInput, $beginDateInput, $endDateInput, $notesInput, $levelInput;
    let $saveButton, $cancelButton, $deleteButton, $eventTableBody, $loadingIndicator, $messageBox, $noRecordsMessage;

    /**
     * Initialize DOM element references using jQuery
     */
    function initializeDOMElements() {
        $formTitle = $('#formTitle');
        $eventForm = $('#eventForm');
        $personInput = $('#person');
        $eventInput = $('#event');
        $beginDateInput = $('#beginDate');
        $endDateInput = $('#endDate');
        $notesInput = $('#notes');
        $levelInput = $('#level');
        $saveButton = $('#saveButton');
        $cancelButton = $('#cancelButton');
        $deleteButton = $('#deleteButton');
        $eventTableBody = $('#eventTable tbody');
        $loadingIndicator = $('#loadingIndicator');
        $messageBox = $('#messageBox');
        $noRecordsMessage = $('#noRecords');

        // Check if all required elements are found
        const requiredElements = [
            $formTitle, $eventForm, $personInput, $eventInput, $beginDateInput, 
            $endDateInput, $notesInput, $levelInput, $saveButton, $cancelButton, 
            $deleteButton, $eventTableBody, $loadingIndicator, $messageBox, $noRecordsMessage
        ];

        const missingElements = requiredElements.filter($el => $el.length === 0);
        if (missingElements.length > 0) {
            console.error('Some DOM elements could not be found:', missingElements);
            return false;
        }

        return true;
    }

    /**
     * Displays a loading indicator.
     */
    function showLoading(message = 'Loading data...') {
        $loadingIndicator.text(message).show();
        $messageBox.hide(); // Hide any previous messages
    }

    /**
     * Hides the loading indicator.
     */
    function hideLoading() {
        $loadingIndicator.hide();
    }

    /**
     * Displays a message (success or error).
     * @param {string} message - The message to display.
     * @param {string} type - 'success' or 'error'.
     */
    function showMessage(message, type) {
        $messageBox
            .text(message)
            .removeClass('success error')
            .addClass(type)
            .show();
        
        hideLoading();
        
        // Hide after 5 seconds
        setTimeout(() => {
            $messageBox.fadeOut();
        }, 5000);
    }

    /**
     * Formats a date for display (handles both Date objects and date strings).
     * @param {Date|string} date - The date to format.
     * @returns {string} Formatted date string or empty string if invalid.
     */
    function formatDateForDisplay(date) {
        if (!date) return '';
        try {
            const dateObj = new Date(date);
            if (isNaN(dateObj.getTime())) return '';
            return dateObj.toLocaleDateString();
        } catch (e) {
            return '';
        }
    }

    /**
     * Formats a date for input fields (YYYY-MM-DD format).
     * @param {Date|string} date - The date to format.
     * @returns {string} Formatted date string or empty string if invalid.
     */
    function formatDateForInput(date) {
        if (!date) return '';
        try {
            const dateObj = new Date(date);
            if (isNaN(dateObj.getTime())) return '';
            return dateObj.toISOString().split('T')[0];
        } catch (e) {
            return '';
        }
    }

    /**
     * Renders the data table with records.
     * @param {Array<Object>} records - An array of record objects.
     */
    function renderTable(records) {
        if ($eventTableBody.length === 0) {
            console.error('Table body element not found');
            return;
        }

        $eventTableBody.empty(); // Clear existing rows
        currentRecords = records; // Store records globally for easy access

        // Gather all unique level values, sorted numerically
        const levelSet = new Set();
        records.forEach(record => {
            const level = parseInt(record.level);
            if (!isNaN(level)) levelSet.add(level);
        });
        const levelList = Array.from(levelSet).sort((a, b) => a - b);

        // Preserve current selections
        const $minLevel = $('#minLevel');
        const $maxLevel = $('#maxLevel');
        const prevMin = $minLevel.val();
        const prevMax = $maxLevel.val();
        $minLevel.empty();
        $maxLevel.empty();
        levelList.forEach(level => {
            $minLevel.append($('<option>').val(level).text(level));
            $maxLevel.append($('<option>').val(level).text(level));
        });
        // Restore previous selection if possible, otherwise use min/max
        if (prevMin && levelList.includes(Number(prevMin))) {
            $minLevel.val(prevMin);
        } else if (levelList.length > 0) {
            $minLevel.val(levelList[0]);
        }
        if (prevMax && levelList.includes(Number(prevMax))) {
            $maxLevel.val(prevMax);
        } else if (levelList.length > 0) {
            $maxLevel.val(levelList[levelList.length - 1]);
        }

        // Get filter values
        const filterMin = parseInt($minLevel.val());
        const filterMax = parseInt($maxLevel.val());
        const filterDateStr = $('#filterDate').val();
        let filterDate = null;
        if (filterDateStr) {
            filterDate = new Date(filterDateStr);
            if (isNaN(filterDate.getTime())) filterDate = null;
        }
        // Defensive copy to avoid mutating original records
        let filteredRecords = records.map(r => ({...r}));
        if (!isNaN(filterMin) && !isNaN(filterMax)) {
            filteredRecords = filteredRecords.filter(record => {
                const level = parseInt(record.level);
                if (isNaN(level)) return false;
                return level >= filterMin && level <= filterMax;
            });
        }
        // Apply date filter if set
        if (filterDate) {
            filteredRecords = filteredRecords.filter(record => {
                const begin = new Date(record.begin);
                const end = record.end ? new Date(record.end) : null;
                if (isNaN(begin.getTime())) return false;
                if (end && !isNaN(end.getTime())) {
                    return filterDate >= begin && filterDate <= end;
                } else {
                    return filterDate >= begin;
                }
            });
        }

        // Sort filteredRecords based on sortBy dropdown
        const sortBy = $('#sortBy').val() || 'person';
        filteredRecords.sort((a, b) => {
            if (sortBy === 'person') {
                return (a.person || '').localeCompare(b.person || '');
            } else if (sortBy === 'begin') {
                const aDate = new Date(a.begin);
                const bDate = new Date(b.begin);
                return aDate - bDate;
            }
            return 0;
        });

        // Update table header for 'Since' column
        const $theadRow = $('#eventTable thead tr');
        $theadRow.empty();
        $theadRow.append('<th>Person</th><th>Event</th><th>Begin Date</th><th>End Date</th><th>Notes</th>' + (filterDate ? '<th>Since</th>' : '') + '<th>Edit</th>');

        if (filteredRecords.length === 0) {
            $noRecordsMessage.show();
            return;
        }
        $noRecordsMessage.hide();

        filteredRecords.forEach(record => {
            const rowId = record.person + '_' + record.event + '_' + record.begin;
            const $row = $('<tr>').attr('data-id', rowId);
            // Highlight Age event rows
            if (record.event === 'Age') {
                $row.addClass('age-row');
            }
            // Create cells for each field. Order matters for display.
            let notesText = record.notes || '';
            if (record.event === 'Age') {
                const begin = new Date(record.begin);
                const end = record.end ? new Date(record.end) : null;
                if (!isNaN(begin.getTime()) && end && !isNaN(end.getTime())) {
                    let years = end.getFullYear() - begin.getFullYear();
                    let months = end.getMonth() - begin.getMonth();
                    let days = end.getDate() - begin.getDate();
                    if (days < 0) {
                        months--;
                    }
                    if (months < 0) {
                        years--;
                        months += 12;
                    }
                    if (years < 0) { years = 0; months = 0; }
                    notesText = `${years} years and ${months} months old`;
                }
            } else if (record.event === 'Married') {
                const begin = new Date(record.begin);
                const end = record.end ? new Date(record.end) : null;
                if (!isNaN(begin.getTime()) && end && !isNaN(end.getTime())) {
                    let years = end.getFullYear() - begin.getFullYear();
                    let months = end.getMonth() - begin.getMonth();
                    let days = end.getDate() - begin.getDate();
                    if (days < 0) {
                        months--;
                    }
                    if (months < 0) {
                        years--;
                        months += 12;
                    }
                    if (years < 0) { years = 0; months = 0; }
                    notesText += (notesText ? ' ' : '') + `Married ${years}y ${months}m`;
                }
            }
            // Create clickable date cells
            const $beginDateCell = $('<td>').text(formatDateForDisplay(record.begin) || '');
            if (record.begin) {
                $beginDateCell.addClass('clickable-date').css('cursor', 'pointer');
                $beginDateCell.on('click', function(e) {
                    e.stopPropagation();
                    $('#filterDate').val(formatDateForInput(record.begin));
                    saveFiltersToLocalStorage();
                    renderTable(currentRecords);
                });
            }
            const $endDateCell = $('<td>').text(formatDateForDisplay(record.end) || '');
            if (record.end) {
                $endDateCell.addClass('clickable-date').css('cursor', 'pointer');
                $endDateCell.on('click', function(e) {
                    e.stopPropagation();
                    $('#filterDate').val(formatDateForInput(record.end));
                    saveFiltersToLocalStorage();
                    renderTable(currentRecords);
                });
            }
            // Edit icon button (smaller, compact SVG)
            const $editBtn = $('<button type="button" class="edit-row-btn" title="Edit" style="background:none;border:none;padding:0;margin:0;line-height:1;cursor:pointer;"><svg width="16" height="16" viewBox="0 0 20 20" fill="none" style="display:inline-block;vertical-align:middle;"><path d="M14.85 2.85a1.2 1.2 0 0 1 1.7 1.7l-1.1 1.1-1.7-1.7 1.1-1.1zm-2.1 2.8 1.7 1.7-8.1 8.1c-.1.1-.2.2-.3.3l-2.1.6c-.3.1-.6-.2-.5-.5l.6-2.1c.1-.1.2-.2.3-.3l8.1-8.1z" fill="#0074d9"/></svg></button>');
            $editBtn.on('click', function(e) {
                e.stopPropagation();
                selectRow(rowId, true); // pass true to indicate show form
                // Scroll to form
                $('html, body').animate({ scrollTop: $('#editFormContainer').offset().top }, 300);
            });
            // Make name clickable to filter by level
            const $nameCell = $('<td>').addClass('clickable-name').css({'text-decoration':'underline','color':'#0074d9','cursor':'pointer'}).text(record.person || '');
            $nameCell.on('click', function(e) {
                e.stopPropagation();
                $('#minLevel').val(record.level);
                $('#maxLevel').val(record.level);
                saveFiltersToLocalStorage();
                renderTable(currentRecords);
            });
            $row.append(
                $nameCell,
                $('<td>').text(record.event || ''),
                $beginDateCell,
                $endDateCell,
                $('<td>').text(notesText)
            );
            if (filterDate) {
                const begin = new Date(record.begin);
                let sinceText = '';
                if (!isNaN(begin.getTime())) {
                    const diff = diffYearsMonths(begin, filterDate);
                    if (diff) {
                        sinceText = diff;
                    }
                }
                $row.append($('<td>').text(sinceText));
            }
            $row.append($('<td>').append($editBtn));
            $eventTableBody.append($row);
        });

        // Add CSS for .age-row if not present
        if (!document.getElementById('age-row-style')) {
            const style = document.createElement('style');
            style.id = 'age-row-style';
            style.innerHTML = '.age-row { background-color: #fffbe6 !important; }';
            document.head.appendChild(style);
        }

        // Add CSS for clickable date cells
        if (!document.getElementById('clickable-date-style')) {
            const style = document.createElement('style');
            style.id = 'clickable-date-style';
            style.innerHTML = '.clickable-date { text-decoration: underline; color: #0074d9; }';
            document.head.appendChild(style);
        }

        hideLoading();
    }

    // Helper to calculate difference in years and months
    function diffYearsMonths(start, end) {
        if (!(start instanceof Date) || !(end instanceof Date)) return '';
        if (isNaN(start.getTime()) || isNaN(end.getTime())) return '';
        let years = end.getFullYear() - start.getFullYear();
        let months = end.getMonth() - start.getMonth();
        let days = end.getDate() - start.getDate();
        if (days < 0) {
            months--;
        }
        if (months < 0) {
            years--;
            months += 12;
        }
        if (years < 0) return '';
        let result = '';
        if (years > 0) result += years + 'y';
        if (months > 0) result += (result ? ' ' : '') + months + 'm';
        if (!result) result = '0m';
        return result;
    }

    // Helper to populate dropdowns with unique values from records
    function populateDropdown($select, values, currentValue) {
        $select.empty();
        values.forEach(val => {
            const $opt = $('<option>').val(val).text(val);
            if (val == currentValue) $opt.prop('selected', true);
            $select.append($opt);
        });
    }

    // Set form fields to readonly/disabled or editable
    function setFormReadOnly(isReadOnly) {
        $('#person').prop('disabled', isReadOnly);
        $('#event').prop('disabled', isReadOnly);
        $('#beginDate').prop('readonly', isReadOnly);
        $('#endDate').prop('readonly', isReadOnly);
        $('#level').prop('disabled', isReadOnly);
        $('#notes').prop('readonly', isReadOnly);
        $('#saveButton').prop('disabled', isReadOnly);
    }

    // Populate form dropdowns with unique values from records
    function populateFormDropdowns(records, currentRecord) {
        // Person
        const personSet = new Set();
        // Event
        const eventSet = new Set();
        // Level
        const levelSet = new Set();
        records.forEach(r => {
            if (r.person) personSet.add(r.person);
            if (r.event) eventSet.add(r.event);
            if (r.level) levelSet.add(r.level);
        });
        populateDropdown($('#person'), Array.from(personSet).sort(), currentRecord ? currentRecord.person : '');
        populateDropdown($('#event'), Array.from(eventSet).sort(), currentRecord ? currentRecord.event : '');
        populateDropdown($('#level'), Array.from(levelSet).sort((a,b)=>a-b), currentRecord ? currentRecord.level : '');
    }

    /**
     * Selects a row in the table, populating the form for editing.
     * @param {string} rowId - The unique ID of the record to select.
     */
    function selectRow(rowId, showForm) {
        $('.data-table tr.selected-row').removeClass('selected-row');
        $(`.data-table tr[data-id="${rowId}"]`).addClass('selected-row');
        selectedRowId = rowId;
        const record = currentRecords.find(r => (r.person + '_' + r.event + '_' + r.begin) === rowId);
        if (record) {
            $formTitle.text('Edit Timeline Event');
            populateFormDropdowns(currentRecords, record);
            $('#person').val(record.person || '');
            $('#event').val(record.event || '');
            $('#beginDate').val(formatDateForInput(record.begin) || '');
            $('#endDate').val(formatDateForInput(record.end) || '');
            $('#notes').val(record.notes || '');
            $('#level').val(record.level || '');
            setFormReadOnly(false); // Make fields editable
            $('#editButton').hide();
            $('#saveButton').prop('disabled', false);
            $deleteButton.show();
            if (showForm) {
                $('#dataTableContainer').hide();
                $('#editFormContainer').show();
                $('#filterCriteriaContainer').hide();
            }
        }
    }

    /**
     * Clears the form and resets it for adding a new event.
     */
    function resetForm() {
        if ($eventForm.length === 0) {
            console.error('Form elements not found');
            return;
        }
        $eventForm[0].reset();
        $formTitle.text('Add New Timeline Event');
        populateFormDropdowns(currentRecords, null);
        setFormReadOnly(false);
        $('#editButton').hide();
        $('#saveButton').prop('disabled', false);
        $deleteButton.hide();
        selectedRowId = null;
        $('.data-table tr.selected-row').removeClass('selected-row');
        $('#editFormContainer').hide();
        $('#dataTableContainer').show();
    }

    /**
     * Fetches all records from the Google Sheet.
     */
    function fetchRecords() {
        showLoading();
        google.script.run
            .withSuccessHandler(records => {
                renderTable(records);
                hideLoading();
            })
            .withFailureHandler(error => {
                showMessage('Error fetching data: ' + error.message, 'error');
            })
            .getData();
    }

    /**
     * Validates the form data before submission.
     * @param {Object} record - The record object to validate.
     * @returns {boolean} True if valid, false otherwise.
     */
    function validateRecord(record) {
        if (!record.person || !record.event || !record.begin) {
            showMessage('Please fill in all required fields (Person, Event, Begin Date).', 'error');
            return false;
        }

        // Validate begin date
        const beginDate = new Date(record.begin);
        if (isNaN(beginDate.getTime())) {
            showMessage('Please enter a valid Begin Date.', 'error');
            return false;
        }

        // Validate end date if provided
        if (record.end) {
            const endDate = new Date(record.end);
            if (isNaN(endDate.getTime())) {
                showMessage('Please enter a valid End Date.', 'error');
                return false;
            }
            if (endDate < beginDate) {
                showMessage('End Date cannot be earlier than Begin Date.', 'error');
                return false;
            }
        }

        // Validate level if provided
        if (record.level) {
            const level = parseInt(record.level);
            if (isNaN(level) || level < 0) {
                showMessage('Level must be a positive number.', 'error');
                return false;
            }
        }

        return true;
    }

    /**
     * Handles form submission for adding or updating records.
     */
    function handleFormSubmit(e) {
        e.preventDefault();
        showLoading('Saving data...');
        // Always save dates in YYYY-MM-DD format
        function toYMD(val) {
            if (!val) return '';
            const d = new Date(val);
            if (isNaN(d.getTime())) return '';
            return d.toISOString().split('T')[0];
        }
        const record = {
            person: $('#person').val(),
            event: $('#event').val(),
            begin: toYMD($('#beginDate').val()),
            end: toYMD($('#endDate').val()),
            notes: $('#notes').val(),
            level: $('#level').val()
        };
        if (!validateRecord(record)) {
            return;
        }
        if (selectedRowId) {
            google.script.run
                .withSuccessHandler(() => {
                    showMessage('Record updated successfully!', 'success');
                    showTableHideForm();
                    fetchRecords();
                })
                .withFailureHandler(error => {
                    showMessage('Error updating record: ' + error.message, 'error');
                })
                .updateRow(record);
        } else {
            google.script.run
                .withSuccessHandler(() => {
                    showMessage('Record added successfully!', 'success');
                    showTableHideForm();
                    fetchRecords();
                })
                .withFailureHandler(error => {
                    showMessage('Error adding record: ' + error.message, 'error');
                })
                .addRow(record);
        }
    }

    /**
     * Handles deletion of a record.
     */
    function handleDelete() {
        if (selectedRowId && confirm('Are you sure you want to delete this timeline event?')) {
            showLoading('Deleting record...');
            google.script.run
                .withSuccessHandler(() => {
                    showMessage('Record deleted successfully!', 'success');
                    showTableHideForm();
                    fetchRecords(); // Refresh table
                })
                .withFailureHandler(error => {
                    showMessage('Error deleting record: ' + error.message, 'error');
                })
                .deleteRow(selectedRowId);
        }
    }

    /**
     * Handles canceling an edit/add operation.
     */
    function handleCancel() {
        showTableHideForm();
    }

    /**
     * Initialize event listeners using jQuery
     */
    function initializeEventListeners() {
        $eventForm.on('submit', handleFormSubmit);
        $deleteButton.on('click', handleDelete);
        $cancelButton.on('click', handleCancel);
    }

    /**
     * Add some nice jQuery effects and enhancements
     */
    function addEnhancements() {
        // Add hover effects to table rows
        $(document).on('mouseenter', '.data-table tbody tr', function() {
            $(this).addClass('hover-effect');
        }).on('mouseleave', '.data-table tbody tr', function() {
            $(this).removeClass('hover-effect');
        });

        // Add smooth transitions
        $('.data-table tbody tr').css('transition', 'background-color 0.2s ease');
        
        // Add focus effects to form inputs
        $('input, textarea').on('focus', function() {
            $(this).addClass('focused');
        }).on('blur', function() {
            $(this).removeClass('focused');
        });
    }

    // Store and restore filter settings
    function saveFiltersToLocalStorage() {
        localStorage.setItem('timelineFilters', JSON.stringify({
            minLevel: $('#minLevel').val(),
            maxLevel: $('#maxLevel').val(),
            filterDate: $('#filterDate').val(),
            sortBy: $('#sortBy').val()
        }));
    }
    function restoreFiltersFromLocalStorage() {
        const filters = JSON.parse(localStorage.getItem('timelineFilters') || '{}');
        if (filters.minLevel) $('#minLevel').val(filters.minLevel);
        if (filters.maxLevel) $('#maxLevel').val(filters.maxLevel);
        if (filters.filterDate) $('#filterDate').val(filters.filterDate);
        if (filters.sortBy) $('#sortBy').val(filters.sortBy);
    }

    // On filter change, save to localStorage
    $(document).on('change', '#minLevel, #maxLevel, #filterDate, #sortBy', function() {
        saveFiltersToLocalStorage();
        renderTable(currentRecords);
    });
    // On clear, also update localStorage
    $(document).on('click', '#clearFilters', function() {
        const $minLevel = $('#minLevel');
        const $maxLevel = $('#maxLevel');
        const $filterDate = $('#filterDate');
        const $sortBy = $('#sortBy');
        if ($minLevel.children().length > 0) {
            $minLevel.val($minLevel.children().first().val());
        }
        if ($maxLevel.children().length > 0) {
            $maxLevel.val($maxLevel.children().last().val());
        }
        $filterDate.val('');
        $sortBy.val('begin');
        saveFiltersToLocalStorage();
        renderTable(currentRecords);
    });

    // When cancel, save, or delete, hide form and show table
    function showTableHideForm() {
        $('#editFormContainer').hide();
        $('#dataTableContainer').show();
        $('#filterCriteriaContainer').show();
        resetForm();
    }

    // Initialize everything when DOM is loaded
    $(document).ready(function() {
        if (initializeDOMElements()) {
            restoreFiltersFromLocalStorage();
            if (!$('#sortBy').val()) $('#sortBy').val('begin');
            initializeEventListeners();
            addEnhancements();
            fetchRecords();
            setFormReadOnly(false);
            $('#editButton').hide();
            $('#editFormContainer').hide();
            $('#dataTableContainer').show();
        } else {
            console.error('Failed to initialize DOM elements');
            showMessage('Failed to initialize the application. Please refresh the page.', 'error');
        }
    });

</script>
